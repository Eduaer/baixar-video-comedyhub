<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ComedyHub Baixar Vídeo</title>
</head>
<body>
  <h2>HLS (.m3u8) → MP4 no navegador</h2>
  <p>Cole a URL da página do meme ou do .m3u8. Este app baixa os segmentos via proxy e usa ffmpeg.wasm para gerar o MP4 localmente. Pode ser pesado — prefira vídeos curtos.</p>

  <label>URL do meme:</label><br>
  <input type="text" id="urlInput" size="80" value="https://thecomedyhub.com.br/meme/0d2eade9-f80f-443e-a819-fcc81f086f68"><br><br>

  <button id="baixarBtn">Extrair e Baixar MP4</button>
  <button id="apenasM3u8Btn">Apenas extrair .m3u8</button>

  <h3>Progresso</h3>
  <pre id="log"></pre>

  <!-- ffmpeg wasm corrigido -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.9/dist/umd/ffmpeg.min.js"></script>

  <script>
    const logBox = document.getElementById('log');
    function log(msg) {
      logBox.textContent += msg + "\n";
    }

    // Proxy já fixo
    const CORS_PROXY = "https://weathered-breeze-e67b.duduuuu863.workers.dev/";

    async function extrairM3u8(urlPagina) {
      log("Baixando HTML...");
      const resp = await fetch(CORS_PROXY + urlPagina);
      const html = await resp.text();
      log("HTML recebido, procurando m3u8...");
      const match = html.match(/https:\/\/[^"]+\.m3u8/);
      if (!match) throw new Error("Não achei link .m3u8 na página.");
      return match[0];
    }

    document.getElementById('apenasM3u8Btn').onclick = async () => {
      const urlPagina = document.getElementById('urlInput').value.trim();
      try {
        const m3u8 = await extrairM3u8(urlPagina);
        log("Achei m3u8: " + m3u8);
        alert("M3U8 extraído: " + m3u8);
      } catch (e) {
        log("Erro: " + e.message);
      }
    };

    document.getElementById('baixarBtn').onclick = async () => {
      const urlPagina = document.getElementById('urlInput').value.trim();
      try {
        const m3u8 = await extrairM3u8(urlPagina);
        log("Achei m3u8: " + m3u8);

        // carrega ffmpeg.wasm
        log("Carregando ffmpeg.wasm...");
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        await ffmpeg.load();

        log("Baixando playlist .m3u8 via proxy...");
        const playlistResp = await fetch(CORS_PROXY + m3u8);
        const playlist = await playlistResp.text();

        // pega segmentos .ts
        const baseUrl = m3u8.substring(0, m3u8.lastIndexOf("/") + 1);
        const segments = playlist.split("\n").filter(l => l && !l.startsWith("#"));

        log(`Achei ${segments.length} segmentos, baixando...`);
        for (let i = 0; i < segments.length; i++) {
          const segUrl = CORS_PROXY + baseUrl + segments[i];
          const data = await fetchFile(segUrl);
          ffmpeg.FS("writeFile", `seg${i}.ts`, data);
          log(`Baixado segmento ${i+1}/${segments.length}`);
        }

        log("Concatenando com ffmpeg...");
        const concatList = segments.map((s,i)=>`file 'seg${i}.ts'`).join("\n");
        ffmpeg.FS("writeFile","list.txt", new TextEncoder().encode(concatList));
        await ffmpeg.run("-f","concat","-safe","0","-i","list.txt","-c","copy","output.mp4");

        log("Gerando download...");
        const data = ffmpeg.FS("readFile", "output.mp4");
        const url = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));
        const a = document.createElement("a");
        a.href = url;
        a.download = "video.mp4";
        a.click();

        log("Concluído! Arquivo pronto para download.");
      } catch (e) {
        log("Erro: " + e.message);
      }
    };
  </script>
</body>
</html>

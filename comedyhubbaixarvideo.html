<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Extração M3U8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <input id="inputUrl" type="url" placeholder="https://thecomedyhub.com.br/meme/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
  <button id="btnTest">Testar Extração</button>
  <pre id="log"></pre>

  <script>
  const WORKER = "https://weathered-breeze-e67b.duduuuu863.workers.dev/";

  const $ = (id)=>document.getElementById(id);
  const logEl = $("log"), inUrl = $("inputUrl"), btnTest = $("btnTest");
  function log(s){ logEl.textContent += s + "\n"; }
  function setBusy(b){ btnTest.disabled=b; inUrl.disabled=b; }

  async function fetchText(url){
    const r = await fetch(WORKER + "?url=" + encodeURIComponent(url));
    if(!r.ok) throw new Error("HTTP "+r.status+" ao buscar "+url);
    return await r.text();
  }

  function extractM3U8(html, base){
    const cands = new Set();
    try{
      const doc = new DOMParser().parseFromString(html, "text/html");
      doc.querySelectorAll("[src],[href]").forEach(el=>{
        const v = el.getAttribute("src") || el.getAttribute("href");
        if(v && /\.m3u8(\?|#|$)/i.test(v)){
          cands.add(new URL(v, base).href);
        }
      });
    }catch(e){}
    const m = html.match(/https?:\/\/[^\s"'<>]+\.m3u8(?:\?[^\s"'<>]*)?/ig);
    if(m) m.forEach(u=>cands.add(new URL(u, base).href));
    const arr = Array.from(cands);
    arr.sort((a,b)=>{
      const ad = /comedyhub\.b-cdn\.net/.test(a) ? 0 : 1;
      const bd = /comedyhub\.b-cdn\.net/.test(b) ? 0 : 1;
      return ad - bd || a.length - b.length;
    });
    if(arr.length) return arr[0];
    return null;
  }

  async function testExtract(){
    setBusy(true); logEl.textContent="";
    try{
      let url = inUrl.value.trim();
      if(!url) throw new Error("Cole a URL.");
      if(!/\.m3u8(\?|#|$)/i.test(url)){
        log("Baixando HTML…");
        const html = await fetchText(url);
        log("HTML baixado:\n" + html);  // Mostra HTML completo para depuração
        const m3u8 = extractM3U8(html, url);
        if(!m3u8) throw new Error("Não encontrei .m3u8 no HTML.");
        log("Extraído: " + m3u8);
      } else {
        log("É .m3u8 direto: " + url);
      }
    }catch(e){ log("ERRO: "+(e?.message||e)); }
    finally{ setBusy(false); }
  }

  $("btnTest").addEventListener("click", testExtract);
  </script>
</body>
</html>
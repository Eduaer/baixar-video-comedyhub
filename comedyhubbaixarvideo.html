<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>HLS (.m3u8) → MP4 no navegador</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    input, button { padding: 8px; margin: 5px 0; width: 100%; }
    #log { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; border-radius: 6px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>HLS (.m3u8) → MP4 no navegador</h2>
  <p>Cole a URL da página do meme ou do .m3u8. Este app baixa os segmentos via um proxy (CORS) e usa ffmpeg.wasm para gerar o MP4 localmente. Pode ser pesado e consumir muita RAM — prefira vídeos curtos.</p>

  <label>URL do meme (ex.: https://thecomedyhub.com.br/meme/…)</label>
  <input id="url" placeholder="cole aqui a URL do meme ou do .m3u8">
  
  <button onclick="extrair()">Extrair e Baixar MP4</button>
  <button onclick="apenasM3u8()">Apenas extrair .m3u8</button>

  <h3>Progresso</h3>
  <div id="log"></div>

<script>
const WORKER = "https://weathered-breeze-e67b.duduuuu863.workers.dev/";

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

async function fetchPage(url) {
  log("Baixando HTML da página...");
  const resp = await fetch(WORKER + "?url=" + encodeURIComponent(url));
  return await resp.text();
}

function extrairM3u8DoHtml(html) {
  log("Procurando .m3u8 dentro do HTML...");
  const regex = /https?:\/\/[^\s"']+playlist\.m3u8/;
  const match = html.match(regex);
  if (match) {
    log("Achei: " + match[0]);
    return match[0];
  }
  throw new Error("Não achei link .m3u8 na página.");
}

async function apenasM3u8() {
  try {
    const url = document.getElementById("url").value.trim();
    if (!url) return alert("Cole uma URL");
    const html = await fetchPage(url);
    const m3u8 = extrairM3u8DoHtml(html);
    log("Link final: " + m3u8);
    alert("Link .m3u8 encontrado:\n" + m3u8);
  } catch (e) {
    log("Erro: " + e.message);
  }
}

async function extrair() {
  try {
    const url = document.getElementById("url").value.trim();
    if (!url) return alert("Cole uma URL");
    const html = await fetchPage(url);
    const m3u8 = extrairM3u8DoHtml(html);
    await baixarComoMp4(m3u8);
  } catch (e) {
    log("Erro: " + e.message);
  }
}

async function baixarComoMp4(m3u8Url) {
  log("Carregando FFmpeg...");
  const { createFFmpeg } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
  await ffmpeg.load();

  log("Baixando playlist via proxy...");
  const resp = await fetch(WORKER + "?url=" + encodeURIComponent(m3u8Url));
  const playlist = await resp.text();

  // Pega os segmentos .ts
  const base = m3u8Url.substring(0, m3u8Url.lastIndexOf("/") + 1);
  const segmentos = playlist.split("\n").filter(l => l && !l.startsWith("#"));
  log("Achei " + segmentos.length + " segmentos");

  let concatList = "";
  for (let i = 0; i < segmentos.length; i++) {
    const segUrl = base + segmentos[i];
    log(`Baixando segmento ${i+1}/${segmentos.length}`);
    const segResp = await fetch(WORKER + "?url=" + encodeURIComponent(segUrl));
    const data = new Uint8Array(await segResp.arrayBuffer());
    const segName = `seg${i}.ts`;
    ffmpeg.FS("writeFile", segName, data);
    concatList += `file '${segName}'\n`;
  }

  ffmpeg.FS("writeFile", "concat.txt", concatList);

  log("Convertendo para MP4...");
  await ffmpeg.run("-f", "concat", "-safe", "0", "-i", "concat.txt", "-c", "copy", "out.mp4");

  const data = ffmpeg.FS("readFile", "out.mp4");
  const url = URL.createObjectURL(new Blob([data.buffer], { type: "video/mp4" }));

  const a = document.createElement("a");
  a.href = url;
  a.download = "video.mp4";
  a.click();

  log("Download concluído!");
}
</script>
</body>
</html>
